---
title: "Summary of ANCOVA for {{ paste0(paste0('`', dvs, '`'), collapse = ',') }}"
author: {{ author }} <{{ email }}>
comment: This file is automatically generate by Shiny-Statistic app (https://statistic.geiser.tech/)
         Author - Geiser C. Challco <geiser@usp.br>
         
         Shiny-Statistic is distributed in the hope that it will be useful,
         but WITHOUT ANY WARRANTY; without even the implied warranty of
         MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
         GNU General Public License for more details.
         
         You should have received a copy of the GNU General Public License.
         If not, see <https://www.gnu.org/licenses/>.
output:
  github_document: default
  word_document: default
  html_document: default
  pdf_document:
    keep_tex: true
fontsize: 10pt
---

```{r setup, echo=FALSE, purl=TRUE}
library(knitr)
opts_chunk$set(echo = TRUE)
defaultW <- getOption("warn")
options(warn = -1)
```

## Install and Load Packages

```{r, echo=FALSE}
if (!'remotes' %in% rownames(installed.packages())) install.packages('remotes')
if (!"rshinystatistics" %in% rownames(installed.packages())) {
  remotes::install_github("geiser/rshinystatistics")
} else if (packageVersion("rshinystatistics") < "{{ rshinystatistics.version }}") {
  remotes::install_github("geiser/rshinystatistics")
}

wants <- c('ggplot2','ggpubr','rshinystatistics','utils')
has <- wants %in% rownames(installed.packages())
if (any(!has)) install.packages(wants[!has])

library(utils)
library(ggpubr)
library(ggplot2)
library(rshinystatistics)
```

## Load Initial Data and Variables

* R-script file: [ancova.R](ancova.R)
{{ paste0(paste0('* Data for ', dvs, ' [data-',dvs,'.csv](data-',dvs,'.csv)'), collapse = '\n') }}

```{r}
wid <- "{{ wid }}"
covar <- "{{ covar }}"
between <- c({{ paste0(paste0('"', between, '"'), collapse = ',') }})
dvs <- c({{ paste0(paste0('"', dvs, '"'), collapse = ',') }})
ldvs <- as.list(dvs); names(ldvs) <- dvs
dat <- lapply(ldvs, FUN = function(dv) {
  data <- read.csv(paste0("data-",dv,".csv"))
  rownames(data) <- data[["{{ wid }}"]]
  return(data)
})
```

### Descriptive statistics of initial data

```{r}
df <- dat; df[[covar]] <- dat[[1]]
(df <- descriptive_statistics(df, c(dvs,covar), between, include.global = T, symmetry.test = T))
```

```{r, echo=FALSE, purl=FALSE}
kable(df, digits = 3)
```

## Checking of Assumptions

### Assumption: Symmetry and treatment of outliers

```{r}
rdat <- dat
```

#### Applying transformation for skewness data when normality is not achieved in any dependent variables or covariance

{{ code.skewness }}

#### Dealing with outliers (winsorization is used as predefined way)

{{ code.outliers }}


### Assumption: Normality distribution of data

#### Removing data that affect normality (extreme values)

```{r}
non.normal <- {{ code.non.normal }}
(sdat <- remove_from_datatable(rdat, non.normal, wid))
```

#### Result of normality test in the residual model

```{r}
(df <- normality_test_by_res(sdat, dvs, between, c(), covar))
```

```{r, echo=FALSE, purl=FALSE}
kable(df, digits = 3)
```

#### Result of normality test in each group

This is an optional validation and only performed for groups with number greater than 30 observations

```{r}
(df <- descriptive_statistics(dat, dvs, between, include.global = T, normality.test = T))
```

```{r, echo=FALSE, purl=FALSE}
kable(df, digits = 3)
```

**Observation**:

As sample sizes increase, parametric tests remain valid even with the violation of normality <sup>[[1](#references)]</sup>.
According to the central limit theorem, the sampling distribution tends to be normal if the sample is large, more than (`n > 30`) observations.
Therefore, we performed parametric tests with large samples as described as follows: 

- In cases with the sample size greater than 100 (`n > 100`), we adopted a significance level of `p < 0.01`

- For samples with `n > 50` observation, we adopted D'Agostino-Pearson test
that offers better accuracy for larger samples <sup>[[2](#references]</sup>.

- For samples' size between `n > 100` and `n <= 200`, we ignored the normality test,
and our decision of validating normality was based only in the interpretation of QQ-plots
and histograms because the Shapiro-Wilk and D'Agostino-Pearson tests tend to be too sensitive
with values greater than 200 observation<sup>[[3](#references)]</sup>.

- For samples with `n > 200` observation, we ignore the normality assumption based on the central theorem limit.


### Assumption: Linearity of dependent variables and covariate variable

{{ linearity.code }}

### Assumption: Homogeneity of data distribution

```{r}
(df <- homogeneity_test(sdat, dvs, between, c(), covar))
```

```{r, echo=FALSE, purl=FALSE}
kable(df, digits = 3)
```

## Saving the Data for Performing ANCOVA Test 

```{r}
for (dv in names(sdat))
  write.csv(sdat[[dv]],paste0("data-ancova-",dv,".csv"))
```

## Computation of ANCOVA Test and Pairwise Comparison

### ANCOVA test

```{r}
(aov <- ancova.test(sdat, dvs, between, covar, {{ type }}, "{{ effect.size }}", "var"))
```

```{r, echo=FALSE, purl=FALSE}
cnames <- c("var", "Effect", "DFn", "DFd", "SSn", "SSd", "F", "p", "{{ effect.size }}", "p.signif")
kdf <- get.ancova.table(aov)[,cnames]
kable(kdf, digits = 3)
```

### Pairwise comparison

```{r}
(pwc <- ancova.pwc(sdat, dvs, between, covar, "{{ p.adjust.method }}", "var"))
```

```{r, echo=FALSE, purl=FALSE}
cnames <- c("var", between, "group1", "group2","estimate", "se","df","statistic","p", "p.adj","p.adj.signif")
kdf <- get.ancova.pwc.table(pwc, only.sig = F)[,cnames]
kable(kdf, digits = 3)
```

### Estimated Marginal Means and ANCOVA Plots 

```{r}
(emms <- get.ancova.emmeans.with.ds(pwc, sdat, dvs, between, "common", "var"))
```

```{r, echo=FALSE, purl=FALSE}
cnames <- c("var",between,covar,"n","emmean","se.emms","conf.low","conf.high","mean","median","sd","ci")
kable(emms[,cnames], digits = 3)
```

{{ ancova.plots  }}

### Textual Report

{{ ancova.text }}

{{ ancova.pwc.text }}

## References

<sup>[1]</sup>: Ghasemi, A., & Zahediasl, S. (2012). Normality tests for statistical analysis: a guide for non-statisticians. International journal of endocrinology and metabolism, 10(2), 486.

<sup>[2]</sup>: Miot, H. A. (2017). Assessing normality of data in clinical and experimental trials. J Vasc Bras, 16(2), 88-91.

<sup>[3]</sup>: Bárány, Imre; Vu, Van (2007). "Central limit theorems for Gaussian polytopes". Annals of Probability. Institute of Mathematical Statistics. 35 (4): 1593–1621.

```{r include=FALSE, echo=FALSE, purl=FALSE}
options(warn = defaultW)
```
